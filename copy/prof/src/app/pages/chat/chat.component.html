<section class="content mt-2">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <div class="card card-primary" style="height: 100%">
          <div class="card-header" style="display: flex; flex-direction: row; align-items: flex-start">
            <div class="col-3" style="max-width: 30% !important">Tickets</div>
            <div class="col-9" style="padding: 0; display: flex; justify-content: space-evenly">
              <button class="btn btn-sm btn-change-tickets" (click)="listarTicketsEmAberto()"
                [class]="ticketsEmAberto ? 'btn-primary' : 'btn-outline-light'">
                Em Aberto
              </button>
              <button class="btn btn-sm btn-change-tickets" (click)="listarTicketsConcluidos()"
                [class]="!ticketsEmAberto ? 'btn-primary' : 'btn-outline-light'">
                Conclu√≠dos
              </button>
            </div>
          </div>
          <div class="container content enbl-scrll-chatlist">
            <div class="card-body height3 pd0">
              <ul class="chat-list">
                <li *ngFor="let t of tickets; let i = index" (click)="carregarMensagens(i)" [class]="
                    t.cdTicket == ticket?.cdTicket ? 'selected in' : 'in ticket'
                  ">
                  <div class="chat-body" style="width: 90%">
                    <h5 class="title-chatlist">
                      Ticket #{{ t.cdTicket }}
                      <span style="float: right; font-size: 12px">{{
                        t.dtUltMensagem | date: "dd/MM/yyyy HH:mm"
                        }}</span>
                    </h5>
                    <h5 class="title-chatlist limitchars" style="font-size: 13px">
                      <span style="color: #00933e">
                        {{
                        t.cdDisciplina > 0 ? t.nmDisciplina + " -" : ""
                        }} </span><span style="color: dimgrey">{{ t.assunto }}</span>
                    </h5>
                  </div>
                </li>
                <li *ngIf="tickets.length <= 0" style="color: black; text-align: center">
                  Nenhum ticket iniciado.
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-9">
        <div class="card card-primary" style="height: 100%">
          <div class="card-header">
            Mensagens
            <button class="btn btn-sm btn-outline-light btn-change-tickets" (click)="finalizarTicket()"
              style="margin-left: 3%; float: right" *ngIf="ticket != null && ticket.status === 1">
              Finalizar
            </button>
            <span style="float: right; cursor: pointer">
              <i class="fas fa-sync-alt" (click)="refreshMensagens()"></i>
            </span>
          </div>
          <div class="container content enbl-scrll" style="scroll-behavior: smooth">
            <div class="card-body height3">
              <ul class="chat-list">
                <li *ngFor="let m of mensagens; let i = index" [class]="
                    !ticketsEmAberto && i + 1 == mensagens.length
                      ? 'fin'
                      : m.origem == 'D'
                      ? 'out'
                      : 'in'
                  ">
                  <div *ngIf="m.texto != ''">
                    <div class="chat-img" *ngIf="!(m.cdTicketAnexo > 0); else ImgAnexo">
                      <img alt="Avtar" *ngIf="m.origem == 'A'" [src]="
                          m.cdMatricula > 0
                            ? urlSistema + m.cdPessoa + '.JPG'
                            : 'assets/dist/img/avatar.jpg'
                        " onerror="this.src='assets/dist/img/avatar.jpg'" />
                      <div [class]="
                          i + 1 == mensagens.length
                            ? 'prof-finalizado'
                            : 'prof-initial'
                        " *ngIf="m.origem == 'D'" style="
                          height: 56px;
                          display: flex;
                          align-content: center;
                          justify-content: center;
                          align-items: center;
                        ">
                        <p style="text-align: center; margin-bottom: 0">
                          {{ m.nmPessoa[0] }}
                        </p>
                      </div>
                    </div>
                    <ng-template #ImgAnexo>
                      <a class="chat-img" style="color: white !important" [href]="m.linkAnexo" target="_blank">
                        <p style="font-size: 40px">
                          <i class="fas fa-download text-secondary"></i>
                        </p>
                      </a>
                    </ng-template>
                    <div class="chat-body">
                      <div class="chat-message">
                        <h5>{{ m.nmPessoa }}</h5>
                        <p>{{ m.texto }}</p>
                      </div>
                      <p style="
                          color: dimgrey;
                          font-size: 11px;
                          margin-left: 1%;
                          margin-right: 1%;
                        ">
                        {{ m.dtHrMsg | date: "dd/MM/yyyy HH:mm:ss" }}
                      </p>
                    </div>
                  </div>
                </li>
                <li *ngIf="ticket == null" style="
                    color: black;
                    color: #5d5d5d;
                    font-size: 20px;
                    text-align: center;
                  ">
                  Selecione um ticket para continuar uma conversa.
                </li>
              </ul>
            </div>
            <div class="myScrollContainer"></div>
          </div>
          <div class="card card-primary chat-down">
            <div class="col-11" style="
                margin-top: 10px;
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                height: 70%;
              ">
              <div *ngIf="anexos.length > 0" class="col-5">
                <div class="row">
                  <div class="col-12 table-responsive scrollinto">
                    <table class="
                        table table-striped table-bordered table-sm
                        row-border
                        hover
                      " style="font-size: 12px">
                      <tbody>
                        <tr *ngFor="let item of anexos; let i = index">
                          <td>{{ item.name }}</td>
                          <td style="width: 1%">
                            <button class="btn btn-sm btn-outline-danger" (click)="removeSelectedFile(i)"
                              style="border: none">
                              <i class="fa fa-trash" aria-hidden="true"></i>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <textarea class="form-control" [disabled]="ticket == null || ticket.status == 2" [style]="
                  anexos.length > 0
                    ? 'width:56%; resize: none; height: 100%; margin-right: 1%'
                    : 'width:99.5%; height: 100%; resize: none'
                " name="texto" id="texto" [(ngModel)]="texto" (keydown.enter)="onKeydown($event)"
                (keyup.enter)="sendMessage()">
              </textarea>
              <input type="file" hidden multiple [disabled]="ticket == null || ticket.status == 2"
                (change)="selectFiles($event)" #file />
              <button type="button" class="btn btn-secondary fileup" (click)="file.click()">
                <i class="fas fa-paperclip"></i>
              </button>
            </div>
            <div class="col-1 text-center" style="
                display: flex;
                flex-direction: row-reverse;
                margin-top: 10px;
                height: 70%;
              ">
              <button type="button" (click)="sendMessage()" class="btn btn-blue"
                [disabled]="ticket == null || ticket.status == 2">
                Enviar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
